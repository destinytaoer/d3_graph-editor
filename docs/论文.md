# 论文

# 致谢

本论文的工作是在我的毕设导师苏恭超老师的悉心指导才完成的。无论是选题项目进度的不停督促、论文具体要求的细心指导、论文撰写的评改工作，都体现了苏恭超老师的耐心指导和严格要求。在此衷心感谢苏老师在这段时间对我的关心和指导。

另外，我还要特别感谢两个公司。海致星图公司为我打开了数据可视化的大门，学习和构建自己的可视化库。本项目中的灵感大部分来自于我在该公司实践的成果。深圳高新兴对我的论文选题以及项目开发提供了很大的帮助和指导。在我面临选题困惑的时候，给我指明了选题方向。同时在工作期间，给了我大量的时间进行选题项目开发以及论文的撰写。还要特别感谢@谢于中、@李炳烨对我的技术指导。

另外，我也要感谢我的家人和女朋友，他们无条件的支持才使我能够在学校专心完成我的学业。

# 摘要

**基于d3的企业关系数据可视化控件设计与开发**<br />**<br />信息工程学院 电子信息工程专业 朱威龙 学号：2013800283

**【摘要】**数据可视化通过将数据映射为图形、位置和颜色等易辨识的信息，极大提高人们对数据的感知与理解程度，同时能够直观展示数据内部隐含的信息，为人们从数据中挖掘出更多有用的信息提供了便利。

数据可视化领域，大致可分为两类，一类是数据分析领域，R 语言无疑是其中的霸主，其本身就是为了统计分析而设计的，在数据的统计和计算上有着很大的优势；另一类就是数据的可视化呈现，在这个领域，JavaScript 就是当之无愧的王者。凭借着在各种平台和终端以网页形式运行和展示的优秀能力，尤其是PC端的网页展示能力，在信息的传递和数据可视化的呈现上具有非常大的优势。而 D3.js 就是 JavaScript 的一个非常优秀的可视化基础库。

本文主要针对公安人员对社会人员、企业等关系分析的需求，制作一个基于 D3.js 的企业关系可视化的图编辑器 web 控件，旨在透过可视化控件，能够快速分析企业之间以及企业与人员之间的关系，得出企业经营状态、发展趋势等关键信息。

这个图编辑器采用 MVC 架构，将视图层、模型层和控制层三者分离，通过发布订阅模式作为中间通信模块，极大降低框架内部模块间的耦合度。主要包含以下功能：

（1）图谱的设计，实现具有友好交互性、简单易用性和高度定制化的图谱，利用数据来驱动图谱的变更
（2）图谱数据的存储，以及实现撤销和重做功能
（3）图谱节点和边数据的新增、修改、删除
（4）图谱数据的过滤筛选
（5）图谱节点的进一步展开
（6）图谱数据中包含的信息的统计
（7）图谱的导出，图谱数据的导出、导入

这个图编辑器不仅可以进行查看分析，还能进行编辑，使得从其他方面得出的关系可以直接放入页面中，进一步分析关系。同时，其内部的图谱模块具有很高的灵活性和拓展性，适用于很多的定制化关系图谱的展示。

**【关键词】**：数据可视化；D3.js；图谱库；web 控件

# ABSTRACT

**Design and development of enterprise relationship data visualization control based on d3**

**【Abstract】**Data visualization can greatly improve people's perception and understanding of data by mapping data to easily recognized information such as graphics, positions and colors, and at the same time can visually display the hidden information inside the data, it provides convenience for people to dig out more useful information from data.

The field of data visualization can be roughly divided into two categories, one is the field of data analysis, and R language is undoubtedly the Overlord, which is designed for statistical analysis, there are great advantages in the statistics and calculation of data; the other is the visual presentation of data. in this field, JavaScript is a well-deserved King. With the excellent ability to run and display in the form of web pages on various platforms and terminals, especially the ability to display web pages on the PC side, it has great advantages in the transmission of information and the presentation of data visualization. D3.js is a very good visual basic library of JavaScript.

This paper mainly focuses on the needs of public security personnel for the analysis of social personnel, enterprises and other relationships, and makes a map editor web control based on D3.js enterprise relationship visualization, aiming to visually control, it can quickly analyze the relationship between enterprises and personnel, and obtain key information such as business status and development trend.

This diagram editor uses MVC architecture to separate the View layer, model layer and control layer. by publishing the subscription mode as the intermediate communication module, the coupling between modules within the framework is greatly reduced. Mainly includes the following functions:

(1) the design of the map, to achieve a friendly interaction, simple ease of use and highly customized map, using data to drive the change of the map
(2) the storage of map data, as well as the function of cancellation and redo
(3) addition, modification and deletion of map nodes and edge data
(4) filtering and screening of map data
(5) further development of map nodes
(6) statistics of the information contained in the map data
(7) export of maps, export and import of map data

This map editor can not only view and analyze, but also edit, so that the relationship from other aspects can be directly placed on the page to further analyze the relationship. At the same time, its internal map module has high flexibility and expansion, and is suitable for the display of many customized relationship maps.

**【Keywords】**: data visualization; D3.js; relational map; web control

# 1. 引言

## 1.1 研究背景和意义

数据，已经渗透到当今每一个行业和业务职能领域，成为重要的生产因素。人们对于海量数据的挖掘和运用，预示着新一波生产率增长和消费者盈余浪潮的到来。大数据时代的到来，显得数据的可视化尤为重要，已经成为一个非常重要的研究领域。许多报刊杂志、门户网站、新闻、媒体都大量使用可视化技术。

数据可视化主要旨在借助于图形化手段，清晰有效地传达与沟通信息。一图胜千言，相比于纯粹的文字和数字，合理有效的组合数据从而转换为一种简单而直观的图表形式，更有利于我们从数据中分析和获取到有用的信息，从而挖掘其中的潜在效益以及预测其发展趋势。

数据可视化在不断的演变。从基础的手绘数学图表，到 PPT 等软件智能生成图表，再到具有复杂交互的图形界面展示。随着互联网的发展，人们再也离不开手机和电脑，大量的时间花在上面，从其中不断的获取想要的信息。网页的展示，就是其中一种非常重要的信息获取形式。随着数据可视化越来越重要，web 端的各种数据可视化工具也如井喷式地发展，D3 正是其中的佼佼者

D3 的全称是（Data-Driven Documents）是一个基于 web 标准的 JavaScript 可视化库，所以又称为 D3.js。D3 让你更加便捷的基于 SVG、Canvas 以及 HTML 等技术将数据生动的展现出来。需要注意的是，D3 并不是一个图形绘制库 ，它像 JQuery 一样，集成了 DOM 操作库，方便我们去操作 HTML 元素。同时它大量集成了数据处理方法，省却了我们处理数据的繁琐过程。而 D3 之所以能够在这领域中脱颖而出，是因为其核心思想：数据和可视化元素的绑定，通过数据来驱动文档。这使得我们在通过 D3 来操作数据和元素绘图时，能够更加的直观和便捷。

现在市面上出现了很多优秀的图形绘制库，如 ECharts、HighChart，它们能够在进行简单配置之后，将数据展现出来。为什么要选择 D3 来花费大量时间在画图上？EChart 等图形绘制库，集成的更多是常见的图形和交互方式，而使用 D3，是为了高度的定制化，来满足不同企业各种各样的需求。

本课题制作的 web 控件是一个图编辑器，在打造图谱绘制库的完美展示以及良好交互性的同时，还要保证图谱的独立性、可拓展性以及高度可定制化。在图谱绘制库的基础上，实现图编辑器的多种功能，又增加了多种对图谱以及数据操作的功能，如添加额外的信息或者修正展示错误的信息等功能。为用户提供基于底层图谱绘制库拓展额外功能的便利。

## 1.2 主要工作

本课题的主要工作包括：

（1）对企业具体关系的分析以及数据的分析
（2）图谱的选择和数据结构的定义和转换
（3）底层图谱绘制库的实现
（4）图编辑器的架构设计
（5）图编辑器具体功能的实现
（6）性能优化、配置参数的整理以及拓展性的接口整理

## 1.3 论文组织结构

第一章引言部分，主要对本课题的研究背景、研究的意义和主要工作进行简要阐述。
第二章可视化技术介绍，主要对实现数据可视化过程的简要说明以及主流可视化技术和方法的比较。
第三章需求分析与图编辑器设计，主要对企业关系进行数据可视化分析，以及图编辑器架构的设计。
第四章图编辑器的实现，主要讲解图谱绘制库以及图编辑器各功能模块的具体实现方式。
第五章总结与展望，对本课题工作进行总结，指出不足之处以及未来工作的改进方向。

# 2. 数据可视化技术介绍

## 2.1 数据可视化概述

数据可视化研究的是，如何将数据转化成为交互的图形或图像等，以视觉可以感受的方式表达，增强人的认知能力，达到发现、解释、分析、探索、决策和学习的目的。随着科学技术的发展，近些年有人提出，数据可视化应不仅仅可以通过视觉来感知，还可以通过触觉、嗅觉、听觉等进行感知。

狭义上的数据可视化指的是数据用统计图表方式呈现。广义上的数据可视化除了单纯的数据可视化，还包含了信息可视化、科学可视化等多个领域。

科学可视化是可视化领域最早、最成熟的一个跨学科研究与应用领域。面向的领域主要是自然科学，如物理、化学、气象气候、航空航天、医学、生物学等各个学科，这些学科通常需要对数据和模型进行解释、操作与处理，旨在寻找其中的模式、特点、关系以及异常情况。

信息可视化处理的对象是抽象数据集合，起源于统计图形学，又与信息图形、视觉设计等现代技术相关。其表现形式通常在二维空间，因此关键问题是在有限的展现空间中以直观的方式传达大量的抽象信息。
相比来说，科学可视化处理的数据具有天然几何结构（如磁感线、流体分布等），信息可视化更关注抽象、高维数据。柱状图、趋势图、流程图、树状图等，都属于信息可视化最常用的可视表达，这些图形的设计都将抽象的数据概念转化成为可视化信息。

可视分析学被定义为一门以可视交互为基础的分析推理科学。它综合了图形学、数据挖掘和人机交互等技术，以可视交互界面为通道，将人感知和认知能力以可视的方式融入数据处理过程，形成人脑智能和机器智能优势互补和相互提升，建立螺旋式信息交流与知识提炼途径，完成有效的分析推理和决策。

本课题中的数据可视化主要是属于信息可视化的范畴，通过对企业和人的关系数据进行分析，使用关系型图谱把抽象的关系进行整合展示。

## 2.2 数据可视化的实现

一个经典的可视化实现流程，是先对杂乱的数据进行加工过滤，变成有特定意义的数据，然后再转变成视觉可表达的形式，也就是将数据映射为图形信息并转换为绘图数据，最后再通过绘图数据渲染成用户可见的视图。

![](https://cdn.nlark.com/yuque/0/2018/png/84147/1540174265466-885b849f-7753-4760-bde4-4f3ef598cb21.png#align=left&display=inline&height=497&originHeight=844&originWidth=1268&status=done&width=746)

第一步主要属于数据挖掘、统计和分析领域，而本课题中实现数据可视化，主要关注第二和第三步，从有意义的数据转化为用户可见的友好交互图表，专注于图形这一块的领域。

数据的映射过程是从数据到图形的关键步骤。

首先，通过对数据包含信息的分析，进行数据的归类，比如连续、离散，比例、间隔，名词、数字，有序、无序，重要性等等。

![](https://cdn.yuque.com/lark/0/2018/png/3463/1531879832667-f81c915c-718c-4621-aeae-cf9116be476f.png#align=left&display=inline&height=460&originHeight=690&originWidth=843&status=done&width=562)

然后，分析图形具有的属性，对其进行一个类似于前面的归类，并且进行权重、表现力的划分。

![](https://cdn.yuque.com/lark/0/2018/png/3463/1531881915503-f99d6c47-03fd-41bf-9b60-8bbfd4ef7435.png#align=left&display=inline&height=375&originHeight=697&originWidth=932&status=done&width=502)

最后进行一个映射的过程，确定使用哪种图表，确定数据与具体图形属性的对应关系。同时也涉及到一个数据转换的过程，明确绘制图表需要哪些额外的计算数据，如位置坐标、图形大小等。

## 2.3 数据可视化工具的比较

### 2.3.1 编程语言的比较

编程通常是数据可视化领域的一道门槛，即便现在有很多的工具能够帮助我们进行数据可视化，但是，通常这些工具都具有相当大的局限性，当你想要实现自己脑海中的可视化效果时，仍然需要通过编程来实现自定制。

事实上，几乎所有的编程语言都可以做可视化。但是，在数据可视化领域中，目前最流行的有三种：R、Python 和 JavaScript。

R 语言是专门为数据的统计分析而设计的，而这也影响到了这门语言的许多层面，从最基本的语法，到其背后支持的插件、库等，还有社区的研究方向，都专注于数据的统计和分析。这门语言对数据处理的便利，是其他语言望尘莫及的。但是它没有办法直接生成图表，只能通过类似于 ggplot2 绘图库或者 shiny 转化为 JS 前端网页来呈现。

Python 语言应用的领域很广，近几年，由于社区的发展，应用于数据可视化领域插件和库的增多，也越来越方便。但是它既没有 R 语言的数据处理能力，也没有直接展现表格的能力。所以并不适合专注于数据可视化领域的人员。

JavaScript 语言无疑是数据可视化展现的最佳编程语言。凭借着在各种平台和终端以网页形式运行和展示的优秀能力，尤其是PC端的网页展示能力，在信息的传递和数据可视化的呈现上具有非常大的优势。JavaScript 最早就是为了操作网页元素而诞生的，所以它可以很方便的操作网页中的各种元素，无论是动画还是各类交互，通过操作 SVG 元素，它就可以很便捷的操作可视化元素，并且通过网页和各种终端，快速的传递给他人。

本课题就是基于 JavaScript 库 D3.js 来实现数据的可视化。

### 2.3.2 普通工具的比较

在很多人日常工作中，仍然会应用到数据可视化，但是学习编程语言是需要成本的，所以各种可视化工具层出不穷。这些工具的主要核心就是为了让我们能够零基础便捷地创建常用的图表，用于日常的数据可视化展示。

普通大众最常用的就是办公软件 Execl。商业上的产品还有 Tableau、DOMO、PowerBI 等等。

图表工具分成五类，可以按照需求，找到所需要的工具。

（1）简单图表
（2）普通的分析性图表
（3）用于出版的分析性图表
（4）故事型图表
（5）创意型图表

![](https://cdn.nlark.com/yuque/0/2018/png/84147/1540174275230-a4428b9f-d6dd-4f82-8a31-7fa693dbfc92.png#align=left&display=inline&height=372&originHeight=372&originWidth=640&status=done&width=640)

## 2.4 主流 web 可视化技术

### 2.4.1 SVG 和 Canvas 的比较

在介绍 Web 上的数据可视化技术前，我们先了解下 Web 图形的底层技术规范：

- **SVG**：可缩放矢量图形（Scalable Vector Graphics），是基于可扩展标记语言（XML）的用于描述二维矢量图形的一种图形格式。
- **Canvas 2D**：Canvas 通过 JavaScript 来绘制 2D 图形，通过逐像素来进行渲染。
- **Canvas 3D WebGL**：WebGL（Web Graphic Library）是一个 JavaScript API，用于在任何兼容的 Web 浏览器中渲染 3D 图形。WebGL 程序由用 JavaScript 编写的控制代码和用 OpenGL 着色语言（GLSL）编写的着色器代码构成，这种语言类似于 C 或 C++，可在 GPU 上执行。


SVG 基于 XML，这意味着 SVG DOM 中的每个元素都是可用的。您可以为某个元素附加 JavaScript 事件处理器。
在 SVG 中，每个被绘制的图形均被视为对象。如果 SVG 对象的属性发生变化，那么浏览器能够自动重现图形。

在 Canvas 中，一旦图形被绘制完成，它就不会继续得到浏览器的关注。如果其位置发生变化，那么整个场景也需要重新绘制，包括任何或许已被图形覆盖的对象。

Canvas 与 SVG 的比较

（1）Canvas 是逐像素渲染的，依赖分辨率，而 SVG 实际上就是 DOM 元素，不依赖分辨率，所以在可缩放的情况下，SVG 会比 Canvas 更好，Canvas 会出现失真的情况。

（2）Canvas 实际上只是一个元素，通过 JavaScript 在这个元素里进行绘图，图中的图形并不是 DOM 元素，不支持事件处理器，只能在 Canvas 元素上进行绑定，而 SVG 中，每个图形都是 DOM 元素，可以便捷操作、绑定事件处理器，更容易实现交互效果。

（3）Canvas 是基于 JavaScript 来进行绘图的，虽然每一次变更都需要重新绘制整个图形，但是消耗的性能却不大，而 SVG 是基于 XML 元素的，每一个变更都会导致 DOM 渲染的回流和重绘，对性能影响很大，复杂度越高会减慢渲染速度（任何过度使用 DOM 的应用都不快）。也因此 SVG 不能用于游戏应用。

本课题选取的是通过 SVG 来实现图谱的绘制，原因在于：

（1）SVG 的高保真特点，能够保证缩放功能下，正常查看。
（2）图编辑器本身就是选用过滤筛选过的数据，人眼很难从大量的数据中得到有用的信息，所以一般不会出现大量数据的情形，所以对 SVG 的渲染速度影响很小。
（3）SVG 可操作性强，相对于 Canvas，其每个元素都可以保存数据，并且独立操作。可以提供更好的交互性和拓展性。

### 2.4.2 可视化库的比较

目前流行的 JavaScript 可视化库中，大致分为两类：

（1）高度集成，拿来即用的便捷图形库，封装了大量现成的图表。

典型的就是现在最受欢迎的由百度团队开发的 Echart。其最大的优点在于：学习成本低，只需要简单配置即能应用，不需要关注底层实现；由大团队开发，足够健壮；大量现成实例图表可供选择。如同大量现成的插件一样，这也是许多公司选择其的原因。但是也因此很难在其基础上做出修改，只能根据公司具体的业务和数据等，进行二度封装，但是其基本功能都是固定不变的。

（2）底层绘图函数库，在底层 API 的基础上，封装的更加便捷和健壮的绘图函数。

其中最优秀的就是 D3.js。其最大的优点在于：可定制化程度高，完全可以随心所欲绘制图形以及实现交互；封装了大量数据处理、图谱算法以及底层 API 的二度封装，相比于原生实现更加便捷。但是，其学习成本就相对较高，而且，图谱实现的效果和健壮性也完全由使用者决定。其更适合于可视化领域的爱好者，以及专注于可视化领域的公司或者团队，是需要开发一款高度自定制的图谱的最好选择。

### 2.4.3 D3.js 介绍

D3 是 Data-Driven Documents 的缩写，是一个基于 web 标准的 JavaScript 可视化库。D3 可以借助 SVG、Canvas 以及 HTML 将你的数据生动的展现出来。D3 结合了强大的可视化交互技术以及数据驱动 DOM 的技术结合起来，让你可以借助于现代浏览器的强大功能自由的对数据进行可视化。

D3 之所以能从众多的可视化库中脱颖而出，最重要的就是其绘图理念：**数据驱动文档**。通过数据与文档中的元素进行绑定，在绘图的过程中能更便捷和快速根据数据来绘制图形。同时，其内部集成了类似 JQuery 的 DOM 操作库、大量方便操作数据的统计和计算方法、以及绘制各种图形提供的动画、绘图布局和事件的封装。

而且，从 D3 v4 版本开始支持 Canvas，且将各个功能进行模块化，功能更加完善和强大。且后续版本只有 v5，而且变化不大，所以其基本已经成型。

本课题选择 D3 的原因在于：

（1）高度定制化，能够制作完全属于自己的图谱
（2）便捷的操作，大量封装好的数据处理方法和绘图算法，以及强大的功能
（3）社区非常强大，在官方画廊上有许多做好的案例可供参考
（4）v4 版本具有很好的兼容性，兼容 IE 9 以上版本。虽然本课题项目使用 ES6 以及 v5 版本，但是仍会考虑到兼容性，会提供兼容版本。且 v5 回退到 v4 没有任何成本。

# 3. 图编辑器设计

## 3.1 需求分析

### 3.1.1 功能选择

（1）首先是图编辑器的基本功能，也是硬性要求：可新增、修改、删除、查看。同时就应该有撤销和重做的功能。

（2）本课题研究的是 web 控件，那么其必须是嵌入到某个网页之中，应当具有很好的兼容和灵活性。在初始状态下，由于其展示空间可能较小，应当只展示图谱，不能进行相关编辑操作。而是提供一个全屏的按钮，由这个按钮将图编辑器放大，并进入一个可编辑的状态。可编辑状态下，提供一个缩小按钮回到最初状态。

（3）为了方便图谱的编辑和查看，可以进行放大和缩小。在放大缩小上又增加了一个 原始大小和适应屏幕大小 的功能。

（4）为了增强对图谱进行有效的针对性和高效的分析能力，可以进行节点的搜索以及关系的过滤。同时对图谱的总体信息进行大致的统计。且图谱展示信息有限，可以点击具体个体和关系，进行详细的查看。

（5）为了增强图谱的分享和展示能力，设置了图谱的导出和导入功能，导入 JSON 格式数据，导出可以为 JSON 数据或者图片。

（6）为了更加快速的编辑图谱，增加了框选和复制粘贴的功能。

### 3.1.2 图谱的选择

关系的数据可视化，最常见的就是：使用节点来表示个体，使用边来表示个体之间的关系。在这种关系型图谱中，关系与个人同样重要。而需要展示的关系的复杂度将决定图谱的选用。

如果个体之间的关系是相互的，如人与人之间的亲属关系：姐妹、兄弟、父子，都是属于相互对等的，那么可以使用无向图进行表示。如果个体之间的关系是存在指向的，如人与人之间的利益关系：借钱，是属于有指向性的，那么应该使用有向图进行表示。如果个体之间的是单一的，比如组织结构层级，需要表示的关系是由上往下的，那么可以直接用位置和简单的连线树图来展示关系。

在本课题中，为了展示企业与个人之间的关系以及企业与企业之间的关系，选用的是力导向图。力导向图非常适合用于展示关系网络信息，由于其带有力和箭头指向的效果，可以清晰呈现出当前网络的关系，并且具有非常优秀的交互能力。

而在拓展中，可以通过展开企业详情来查看企业的内部组织结构以及相关的负责人，选用的是由上而下的树状图进行展示。组织结构展示最常用的就是树状图，由上而下，能够清晰的展示其层级关系以及部门分类和主要负责人。

### 3.1.3 数据的定义和映射

在构建力导向图时，必不可少的是个体和关系的信息。使用一个对象包含 vertexes 和 edges 两个属性，这两个属性都是一个数组，数组包含的是多个 vertex 或者 edge 的信息，而每一个 vertex 和 edge 都是一个对象。

每一个 vertex 必须具有 _id 唯一标识，name 表示名称，type 表示个体类型，还有其他需要的个体信息。每一个 edge 必须具有 _id 唯一标识，label 表示关系名称，_from 使用顶点 _id 标记边的起点，_to 使用顶点 _id 标记边的终点，type 表示关系类型，还有其他需要的关系信息。

```json
{
  "vertexes": [
  	{
      "_id": "xxx",
      "name": "xxx",
      "type": "xxx",
      //...
    }, // vertex
    //...
  ],
  "edges": [
    {
      "_id": "xxx",
      "label": "xxx",
      "type": "xxx",
      "_from": "xxx",
      "_to": "xxx",
    }, // edge
    //...
  ]
}
```

力导向图关键的算法由 D3 的 force 模块提供，直接使用其力导向图布局即可向数据中添加相应的绘图信息。我们将数据中的顶点类型用图标和颜色进行区分；将名称直接显示在顶点下方用于区分顶点。使用箭头来指明关系的指向；将关系的名称直接显示在边上；关系的类型并不是那么重要，本来打算使用颜色进行区分，但是会与顶点颜色混淆，且边只是一条细线，于是就去掉了关系类型的区分。而个体和关系的其他信息，由于图谱范围有限，只能在点击具体顶点和边查看时，使用弹窗进行显示。

而构建树状组织结构图就相对简单一些。每一个节点都是一个对象，除了包含必要的节点信息外，还包含一个 children 属性，这个属性的值是一个数组，包含着其下一层级的所有节点，依次类推，直到叶子节点的 children 属性为空数组。每一个节点分为不同的类型，都包含 _id 唯一标识，name 表示名称，type 表示类型。

不同类型的节点展示的方式和数据都会不同，如企业，则需要展示企业名称、企业经营状态等，人员则要展示名称、职位等信息，部门则要展示部门名称、主要负责人名称。

```json
{
  "_id": "xxx",
  "name": "xxx",
  "type": "xxx",
  //...
  "children": [
    {
      "_id": "xxx",
      "name": "xxx",
      "type": "xxx",
      //...
      "children": [
        //...
      ]
    },
    //...
  ]
}
```

## 3.2 图编辑器架构

### 3.2.1 MVC 模式

![](https://cdn.nlark.com/yuque/0/2019/png/190267/1554972863521-94d538a2-3283-4ba5-869b-3ea8080392d0.png#align=left&display=inline&height=365&originHeight=365&originWidth=601&size=0&status=done&width=601)<br />MVC模式的意思是，软件可以分成三个部分：

（1）视图（View）：用户界面
（2）控制器（Controller）：业务逻辑
（3）模型（Model）：数据保存

View 传送指令到 Controller，Controller 完成业务逻辑后，要求 Model 改变状态，Model 将新的数据发送到 View，用户得到反馈。**所有通信都是单向的**。

在本课题中，实现的关系型数据可视化工具，设计思想就是使用 MVC 模式把应用分成三个部分。

（1）视图层：视图层由 Toolbar、Graph、Menu、Tooltip、Info、Search 等模块的视图组成，通过控制器接收用户的操作实时更新图编辑器应用的状态。

（2）控制层：控制层是用来接收用户的操作的，主要是通过发布订阅模式以及浏览器自身的事件来订阅视图层的事件，当事件发布时调用模型层中相应的方法来改变数据。主要的业务逻辑都封装在 GraphEditor 中，也是发布订阅模式的调度中心。

（3）模型层：模型层为 GraphEditor 组件包含的各个模块中的数据以及各个模块的操作方法。由于 GraphEditor 为各个模块的父模块，可以直接操作各模块的数据。通过控制器调用相应模块的方法，从而改变各个模块的数据，达到改变各个模块视图的效果。

### 3.2.2 发布订阅模式

![image.png](https://cdn.nlark.com/yuque/0/2019/png/190267/1554976315107-bd301986-0587-4ae3-9e4f-63bb764c4edd.png#align=left&display=inline&height=198&name=image.png&originHeight=248&originWidth=861&size=22219&status=done&width=689)

发布订阅模式中存在三个概念：订阅者、发布者和调度中心。

发布订阅模式通过调度中心进行来规划和管理订阅者和发布者的关系。而发布者和订阅者是不知道对方的存在，发布者只管进行发布，而不用理会有谁进行了订阅，而调度中心接受到发布之后，就会通知所有的订阅者。

与浏览器的事件机制是一样的，浏览器作为调度中心，用户进行点击事件的时候，并不知道会发生什么样的事情。而调度中心

本课题中使用发布订阅模式，旨在将课题项目中的各个模块进行完全解耦，将发布订阅模块作为其他模块的通信中心，使得其他模块能够独立实现自身的功能，而不相互影响。而在主体模块 GraphEditor 对各个子模块进行整合，成为业务逻辑的中心，发布订阅模式的实现也是其中一个子模块。

# 4. 图编辑器的实现

## 4.1 图谱库的封装

### 4.1.1 基础关系图类

封装基础关系图类，是为了减少多个图谱中重复的代码，把关系图谱中公用的属性、方法等都封装在一起，尽可能实现可复用方法，实现大部分基础功能。后续会称之为基类。

这个基类仅仅用于其他绘图类来继承，而不用于实例化。同时，在继承中，可以覆盖基类的方法，进行图谱的个性化设定，实现其强大的拓展性。

基类实现的重点是两个方面：一是绘图方法，二是数据操作方法。D3 是由数据驱动文档的变更，也就是图谱的变更，操作数据的方法也就显得尤为重要。

在图谱基类中，存储三种数据：原始数据、绘图原始数据、真实绘图数据。原始数据是最开始获取到的数据，原始数据需要特定的方法进行修改和访问，不用于直接访问；绘图原始数据是经过 preprocessData 和 layout 方法进行数据转换之后，可用于绘图的数据；真实绘图数据是真正用于绘图的数据，分为顶点和边数据，与绘图原始数据实际上是区分开的，不是相同的存储地址。

图谱的绘制是基于数据的，数据的变更是否需要重新绘制图谱、是否需要重置样式、是否需要变更原始数据、是否需要进行缓存等，都是需要考虑到的。后续再具体功能的实现中，会提到具体的数据操作。

绘图方法是封装好的一系列绘图步骤，其包含了具体的绘制方法、获取绘制配置的方法、重绘和重置样式的方法等。绘制的方法最终由 draw 方法进行整合，初始绘制和重绘时都会进行调用。而获取绘制配置的方法，都会接受到每个元素绑定的数据，可以根据数据以及配置来返回每个图谱元素的样式，每次绘制时，都会调用这些方法来决定样式，可以通过继承类进行重写，根据需求自定义不同类型或者不同状态下的样式。至于重绘和重置样式的方法，是为了在数据变更的时候，能够及时改变图谱，反馈给用户。重绘方法会导致重新绘制整个图谱，而重置样式方法则只会在原有图谱的基础上进行样式的变更，性能上会相对好一些，所以只有当增加或删除了元素时，才需要进行整体的变更。

在基类中，还包含了事件处理器以及部分辅助方法和算法，事件处理器实际上集成于图谱上的，只有基本的缩放、拖拽和点击高亮方法，但是，提供了一定的方法可以在图谱中进行其他事件的绑定。如右键菜单、鼠标移入移出等，可以在继承类中添加，也可以通过直接调用具体方法来绑定事件处理器。

另外值得一提的是基类图谱的样式驱动，使用每个顶点和边的 state 状态来驱动样式的变更。在图谱样式需要发生变化时，如高亮时，将相应顶点和边进行了状态的变更，同时调用 resetStyle 方法，就会根据状态修改所有的样式。而样式的获取就是来自于获取绘图配置的系列方法，它们会根据不同的状态、不同的类型、不同的主题从传入基类的样式配置中获取相应样式。其支持的主题和状态完全由开发者进行配置，而需要进行状态或主题的变更，则需要开发者自行定义，基类中只应用了高亮、置灰、正常三个状态，以及默认主题为 light。

### 4.1.2 力导向图延伸类

在继承自基类后，覆盖其 layout 布局方法，使用了 D3 的 force 模块进行布局（实际上就是数据转换，增加绘图位置信息等）。力导向图，顾名思义，其顶点与顶点之间、顶点和边之间都存在力的关系。

D3 force 模块中，集成了优秀的自然力的仿真的算法，可以通过创建仿真器，向仿真器中增加多种力来完成力导向图的仿真。在本课题的力导向图中，添加了电荷力，使顶点之间存在斥力和引力；添加了弹簧力，使边拉伸或压缩时能够反弹；添加了中心力，使得图谱处于容器的中央。这些力都是可以通过传入的参数进行配置的。

拖拽顶点的功能也会受到力仿真的影响，因此在这里会进行拖拽功能的重写。而其他功能都是可以复用的，因此这个延伸类是非常小的。

### 4.1.3 树结构图延伸类

在继承自基类后，覆盖其 layout 布局方法，使用了 D3 的 tree 模块进行布局（实际上就是数据转换，增加绘图位置信息等）。树状图，顾名思义，其顶点与顶点之间、顶点和边之间都存在力的关系。

树结构的布局常用的有两种，一种从左往后，另一种是从上到下。其呈现的效果也有两种：从左到右的例子如思维导图，可以由边来展示具体信息，顶点一般也是圆形且较小，不用于展示信息，只代表一个节点，可用于增加；从上到下的例子如组织结构图，由顶点来展示具体信息，顶点一般是矩形且较大，而边仅仅用于连接。边的形式也有两种：折线和曲线。这些都是可以由传入参数进行配置的。 

## 4.2 发布订阅模块

发布订阅模块主要负责各个模块之间的通信，也是整个图编辑器的运转的关键，是 MVC 模式中的控制层。

发布订阅模块包含有：订阅池 ponds、订阅 on、只订阅一次 once、发布 emit、取消订阅 off、获取所有订阅者 listeners。

订阅池是一个对象，可以存储不同类型的杂志的所有订阅者，每一个类型的杂志都是一个数组。每一次订阅都需要指明类型和订阅者，然后再向订阅池中相应类型的杂志中添加订阅者。取消订阅时，同样需要指明类型和订阅者，然后从订阅池中相应移除地订阅者。发布时，需要指明发布杂志类型，然后会从订阅池中取出相应类型杂志的所有订阅者，进行一一派送。订阅者实际上都是函数，派送过程其实就是函数的执行。

在实现过程中，存在两点难点：
一是发布时的容错，如果订阅者函数是向订阅池不断增加订阅者，那么就容易出现死循环，所以在发布时，应当锁死当前发布的订阅者名单，后续添加的名单不进行发布，技术上使用数组的克隆来解决，克隆当前发布时的数组，执行这个克隆数组中的订阅者。
二是只订阅一次的实现，只订阅一次，说明在发布时，订阅者执行后应当移除当前订阅者，技术上使用了代换，把订阅者换成另外的一个订阅者，而在这个代换的订阅者中挂载源订阅者，然后执行并移除源订阅者，来实现一次订阅，那么在移除时，也需要判断是否是当前订阅者或源订阅者。

另外，本课题的实现中，各模块的通信并不是都由发布订阅模式来完成，发布订阅模式最大作用是个模块进行解耦。在实现过程中，为了使得图谱等模块中方法的灵活性，适当的为一些方法添加了回调函数，使得在其功能的完成过程中还能调用其他模块的功能，也是其中的一部分通信。

## 4.3 图编辑器各个功能的实现

### 4.3.1 数据的缓存和撤销、重做功能

数据的存储是图编辑器的关键。前面说到，图谱中存储的数据有三种，那么我们在进行缓存的是哪一种？我们不可能单纯存储顶点或边的数据，所以只有两个选择：原始数据和绘图原始数据。

如果使用原始数据，那么每次进行缓存的读取时，仍然需要进行必要的数据转换成绘图数据，然后再进行绘制。而使用绘图原始数据时，我们就可以直接跳过数据转换而进行图谱的绘制，但是，只存储绘图原始数据的话，就会丢失图谱中原始数据，如果需要不丢失，仍然会需要进行数据转换。所以根据实际情况，在缓存中，我们将要存储的是原始数据。

本课题中使用 Cache 模块来完成数据的缓存，其内部实现了缓存数据、获取前一个或下一个缓存、清空缓存等方法，以便于更好的操作缓存。撤销、重做功能的实现，实际上就是缓存的获取，获取缓存之后，改变图谱的原始数据，并进行重新绘制，达到图谱的回溯效果。

而实现时最关键的是，应当在什么时候进行数据的缓存。首先是初始绘制时，增加了第一个缓存，然后就是原始数据改变时，新增、修改、删除都会改变原始数据，而过滤实际上只是简单的数据过滤，改变实际绘图的数据，但是其原始数据和原始绘图数据是不变的。

### 4.3.2 图谱的缩放和拖拽功能

图谱中的缩放和拖拽功能是为了实现更加友好的交互，与实际图谱应用并没有太大的关联。

本课题的图编辑器中，实现了四种缩放，点击按照一定比例缩放、点击回到原始大小、点击缩放至适应屏幕以及使用滚轮进行缩放。最难实现的是适应屏幕缩放，需要动态计算图谱大小以及可视区域大小等进行计算缩放比例，而其移位还需要根据缩放来确定，另外三种只是简单的缩放比例改变。缩放应该具有最大最小的缩放范围，可以通过传入配置进行变更。

而最值得注意的是缩放带来的很多方面的副作用，在 D3 中，使用 scale 模块实现缩放，其本身实现中自带有拖拽图谱进行移动的功能，也就是移位。在 web 实现中，几乎所有变形都需要按照一定顺序才能实现效果，相互之间存在一定的影响。而移位的数值是会受到缩放的影响的。所以在前面适应屏幕大小时，需要将图谱居于页面中间需要移位会受到一定影响。同时与位置相关的都会受到一定程度影响，如新增顶点和连线时，需要在计算位置时，去除缩放和移位带来的影响，使其出现在正确的位置上。

本课题中的拖拽功能，除了缩放自带的图谱拖拽，还具有顶点的拖拽功能。这个功能由 D3 的 drag 模块实现，对顶点进行一定的拖拽，但是对于本课题来说，力导向图的拖拽会伴随着力的存在而变化，而组织结构树则是固定的结构，拖拽反而是没有必要的，所以这个拖拽的功能可以动态进行配置，或者可以将其去除。

### 4.3.3 图谱的新增、修改、删除功能

图谱的新增、修改、删除是最基础的编辑功能，基于图谱中操作数据的方法以及绘制图谱的方法进行。新增/修改和删除都需要重新绘制整个图谱，三个功能选项几乎都是集成在 Menu 菜单中，需要与 Menu 通信获取其点击的响应。同时，这三个操作都会生成一个缓存，用于撤销。

新增、修改、删除主要都是数据的改变同时重新根据数据渲染图谱。需要注意的是，删除顶点时，需要同时删除所有与其相关联的边，关系是以个体为基础的。而修改需要一个表单弹窗进行保存，需要与 Modal 模块进行通信，在创建 Menu 菜单时，就会将顶点或边的 ID 绑定在元素上，以便获取到相应数据来填入表单中。新增顶点时，通过 Menu 点击实现，而新增边时，通过拖拽连线来完成，这样能够实现更好的交互；新增的顶点或边的数据都是只有基础数据，需要通过修改来完善其信息。

另外值得一提的是，图谱展示的个体和关系的信息是有限的或者说是极其简单的，而有时候我们需要获取更多的详细信息，此时可以通过 Menu 菜单的查看来展示一个 Tooltip 信息浮窗，提供用户查看更加详细的信息，并且在配置中可以设置具体的查看权限和编辑权限。

### 4.3.4 数据的筛选和信息统计

数据的筛选和信息的统计能够满足客户对数据快速定位分析的需求。在这个功能中，更多的使用了绘图基类中数据操作的方法来完成功能，与 Toolbar、Search、Info 协作完成。

顶点需要准确的查找，由输入框表单来决定，而关系一般只需要关注其类型，使用多选框进行选择过滤。需要展示的表单以及信息面板中的数据，都可以由配置决定。

此功能实现的关键在于：

（1）筛选面板、信息面板的展示与 Toolbar 状态的联动
（2）筛选过程中，应该保留绘图原始数据，用于恢复，而每次筛选都是基于绘图原始数据进行的，修改的是真实绘图的数据
（3）在图谱变动时，同步改变信息面板

### 4.3.5 图谱的导入、导出功能

导入、导出数据可以实现图谱的共享，也可以通过对数据的修改更加快捷的修改整个图谱而不需要在图编辑器中一步步操作。图编辑器的新增、修改、删除功能，实际上都是为了后期能够有效调整图谱中的错误以及应对新的关系的出现。而导出为图片能够更加灵活的在其他地方进行图谱的展示。

导入数据需要使用 HTML  input 标签实现，设置其 type 为 upload，然后手动触发点击，来调用浏览器上传文件的窗口。通过监听 input 的 change 事件来监听文件的上传，利用原生 API FileReader 来读取文件内容，利用 onload 事件监听其读取进度，当文件读取完成时，就能得到文件结果。将文件结果字符串转换为数据对象，改变图谱的原始数据并重新渲染图谱。需要注意的是，此时操作的不是同一数据源，要清空缓存，重新操作。

导出数据利用了 HTML a 标签，先通过 Blob 类生成 blob 类型数据；然后通过原生 API URL.createObjectURL(blob) 生成数据的链接，放置在 a 标签的 href 属性中；最后手动触发 a 标签的点击，从而调取浏览器的下载文件窗口。导出为图片也同样利用这个原理，由于 Canvas 原生具有可导出特性，而 SVG 不具备，所以需要先把 SVG 转换为 Image 图像，再运用到 Canvas 中，利用 Canvas 的特性才能进行导出。

图片的导出存在几个问题仍未解决：

（1）导出图片的清晰度较差
（2）丢失了原本嵌入 SVG 中的图像。

因此，这个功能仍有待完善。

## 4.4 图编辑器的优化

### 4.4.1 减少 DOM 的回流和重绘

SVG 中每一个图形都是 DOM 元素，那么不可避免的，每一次图谱的绘制、更新，都会触发 DOM 树的回流和重绘。浏览器在渲染页面时，通常分为几个步骤：计算 DOM 树 => 加载 CSS 生成渲染树 => 交给 GPU 真正渲染成浏览器页面。每一次增加、移除元素或者改变元素位置、内容等，都会触发 DOM 树的重新计算，也就是从第一步开始重新渲染，这叫做 DOM 的回流，是最影响浏览器性能的。而每一次修改元素的属性、样式等信息，都会触发渲染树的重新生成，也就是从第二步开始重新渲染，这叫做 DOM 的重绘，相对来说，重绘的影响没有回流的消耗那么大。

由于重绘和回流影响性能的问题，实际上，浏览器自身也有优化的策略。浏览器会维护一个队列，把所有会引起回流、重绘的操作放入这个队列。等队列中的操作到了一定的数量或者到了一定的时间间隔，浏览器就会释放队列，进行一个批处理。这样就会让多次的回流、重绘变成一次回流重绘。但有时候我们写的一些代码可能会强制浏览器提前释放队列，这样浏览器的优化可能就起不到作用了。比如：当你向浏览器请求一些样式信息的时候，就会让浏览器释放队列，才能获取的最新的样式。

优化方案主要有以下三个：

（1）分离读写。把对 DOM 的读和写尽可能分开并且把写的过程放到一起或者把不会改变的样式提前读取存在变量中。尽可能减少在写操作的过程中又进行读操作，这是最大化利用浏览器自身优化策略。这样可以大量减少 DOM 的回流和重绘。这是在写代码的过程中需要注意的。

（2）基于文档碎片减少回流。基于 JavaScript 原生 API Document Fragment，在虚拟空间中开辟的一个容器：每当创建一个元素，先把它存放到文档碎片中（暂时不放到页面中，避免回流），当我们把需要的元素都创建完成，并且都添加到文档碎片中，再统一把文档碎片放到页面中，因此只会引发一次回流。

（3）基于字符串拼接减少回流。其原理与第二种方案一样，只是其利用的是字符串拼接。把需要展示的结构拼接成字符串，最后统一在插入到原有容器中。理论上说，这种方式性能不如前面提到的文档碎片。因为浏览器还要把字符串编译成 HTML 元素。但是这种方式很简单，所以真实项目中较常用。

而在本课题中，使用的优化方案主要是第一种和第二种。第一种用于图谱样式的简单改变，不触发回流，那么就不需要重新插入到文档中，需要在代码中重新调整读和写的顺序；第二种方案用于重新绘制整个图谱，只触发一次回流，有效减少性能的消耗。

### 4.4.2 缓存上限

图编辑器会在每一次图谱数据的改变时，都进行图谱数据的缓存，用于撤销和重做功能。虽然在实际应用中图编辑器对图谱数据的改变操作可能会很少，但是仍然不可避免有很多操作的情况。为缓存增加上限，也是处理撤销重做的常见方式，默认设定的最大缓存为 20，已经足够正常的使用，当然也可以通过配置进行修改。

为了功能足够友好，后期还提供了恢复到原始数据的按钮，可以将图谱数据恢复到初始阶段。而这个初始阶段是由 Cache 模块进行保存，也从 Cache 中进行获取。图编辑器的初始化以及每次数据的导入都会重新初始化 Cache，此时就会保存这个数据，而恢复初始数据，也只能恢复到这个阶段。

### 4.4.3 容错性和兼容性

JavaScript 是动态类型语言，其带来巨大灵活性的同时，也给我们带来了一定的困扰，经常会出现一些意想不到的错误。为了更好的容错性，以及后端开发者开始从事前端，越来越多的前端开发者开始使用具有类型系统的 JavaScript 进行开发，如 TypeScript、Flow 等，可以帮助我们预防和发现问题。在优秀的插件、类库中，都会出现很多的类型校验等与真实应用无关的代码，但是其可以更加友好的提示开发者，在什么地方出现错误了。在本课题中，在后期手动为其传入的配置参数进行了一定的类型校验，在通用方法中也添加了容错性，比如获取一个变量的属性时，先进行变量值是否存在的判断等。

在本课题项目初始时，选用 ES6+ 进行开发，不进行兼容性的考虑，避免了在开发过程中，大量使用冗余代码以及会费思考兼容方案的时间，将兼容性交由后期进行调试。首先，需要对 ES6+ 进行转义，ES6+ 在低版本浏览器中没有办法运行，使用 babel 将其转换成 ES5 的语法，能够具有更好的兼容性；另外，使用 pollfill 进行针对性的兼容措施，如 IE 浏览器等对 ES5 部分原生 API 不支持等情况。随着市场的发展，谷歌一家独大，IE 逐渐退出历史的舞台，Edge 也将在未来版本中使用 Chrome 内核，国产大部分浏览器也都使用 Chrome 内核，进行兼容处理的代价也将越来越小，但仍然是必要的。

# 5. 总结和展望

## 5.1 图编辑器的不足

图编辑器是一款以 web 控件形式存在的，嵌入到网页作为网页的一部分，其功能注定会受到限制，与其他市场上大部分专注于图谱编辑的网站相比，其编辑功能不具备任何的优势。其更多的是为了图谱的展示和细微的调整。

在开发过程中，仍存在一些不够理想的地方需要改进。仍有部分 bug 需要修复，部分样式和交互需要调整，部分功能需要完善。在后续，还需要投入一定时间对其进行完善。

## 5.2 图谱库的不断拓展

本课题实现的是一款 web 控件 —— 图编辑器，但是最重要的却是图谱库。图编辑器虽然后续仍然可以修改以及增加其他一些功能，但是其主体已经基本确定，其大部分模块以及主体的 GraphEditor 依然可以直接使用。而图谱库就存在更大的发展空间，并且其不仅仅用于图编辑器，还可以用于其他方面的展示。

目前，本课题实现的图谱仅仅是关系图谱中的力导向图和树状图的绘制，其能满足的需求就非常有限，而数据可视化中，仍然具有大量常用的图谱。在后续，会不断的拓展图谱来完善图谱库，根据实际中的反馈进行修改以满足更多的需求。

# 参考文献

[1] d3.js：[https://d3js.org/](https://d3js.org/)
[2] SVG | MDN 地址：[https://developer.mozilla.org/zh-CN/docs/Web/SVG/Tutorial](https://developer.mozilla.org/zh-CN/docs/Web/SVG/Tutorial)
[3] Nick Qi Zhu，D3.js 数据可视化实战手册，信息技术第一出版社，2014.9
[4] 可视化编程入门--我该选择哪一门语言？ [http://blog.infographics.tw/2016/08/coding-intro/](http://blog.infographics.tw/2016/08/coding-intro/)
[5] Julie Steele；Noah Iliinsky，数据可视化之美，机械工业出版化，2011.6
[6] 陈为；沈则潜，数据可视化，电子工业出版社，2013.12
[7] 数据可视化入门教程，墨者学院：[https://www.yuque.com/mo-college/beginner-tutorial](https://www.yuque.com/mo-college/beginner-tutorial)
[8] Scott Murray，数据可视化实战：使用 D3 设计交互式图表，人民邮电出版社，2013.6
[9] 乔斯·德克森，Three.js开发指南：WebGL 的 JavaScript 3D库，机械工业出版社，2017.9
